<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Location-based AR.js</title>
    <!-- include aframe -->
    <script src="https://aframe.io/releases/1.0.4/aframe.js"></script>
    <!-- include ar.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
  </head>

  <body style="margin: 0; overflow: hidden;">
    <div style='position: fixed; top: 10px; width:100%; text-align: center; z-index: 1;'>
      <button onclick="pragueOfficeTurn()">CGI PRAGUE</button>
      <button onclick="brnoOfficeTurn()">CGI BRNO</button>
      <button onclick="ostravaOfficeTurn()">CGI OVA</button>
    </div>	
    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-assets>
        <a-asset-item id="arrow-obj" src="arrow-obj/nnf-arrow.obj"></a-asset-item>
        <a-asset-item id="arrow-mtl" src="arrow-obj/nnf-arrow.mtl"></a-asset-item>
        <a-asset-item id="arrow0-obj" src="arrow-obj/arrow0.obj"></a-asset-item>
        <a-asset-item id="arrow0-mtl" src="arrow-obj/arrow0.mtl"></a-asset-item>
        <a-asset-item id="arrow1-obj" src="arrow-obj/arrow1.obj"></a-asset-item>
        <a-asset-item id="arrow1-mtl" src="arrow-obj/arrow1.mtl"></a-asset-item>
      </a-assets>
      <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: .intersectable; useWorldCoordinates: true;"></a-entity>
      <a-entity wrapper id="wrapper" position="0 -8 0" emitevents="true">
        
        <a-box material="color: yellow" gps-entity-place="latitude: 49.8291155; longitude: 18.1640326" position="0 0 0"/>
        <a-box material="color: blue" gps-entity-place="latitude: 49.8291755; longitude: 18.1640326" position="0 0 0"/>
        <a-box material="color: red" gps-entity-place="latitude: 49.8291455; longitude: 18.1640526" position="0 0 0"/>
        <a-box material="color: green" gps-entity-place="latitude: 49.8291955; longitude: 18.1640126" position="0 0 0"/>
        <a-entity arrow id="arrow" class="intersectable" obj-model="obj: #arrow-obj; mtl: #arrow-mtl" position="0 0 -10" scale="0.1 0.1 0.1" rotation="0 0 0"></a-entity>
       <!-- 
        
        <a-entity arrow45 id="arrow45" class="intersectable" obj-model="obj: #arrow0-obj; mtl: #arrow0-mtl" position="0 0 1" scale="2 2 2" rotation="0 0 0"></a-entity>
        <a-entity arrow46 id="arrow46" class="intersectable" obj-model="obj: #arrow0-obj; mtl: #arrow0-mtl" position="0 0 -1" scale="2 2 2" rotation="0 0 0"></a-entity>
        <a-entity arrow47 id="arrow47" class="intersectable" obj-model="obj: #arrow0-obj; mtl: #arrow0-mtl" position="0 1 0" scale="2 2 2" rotation="0 0 0"></a-entity>
        <a-entity arrow48 id="arrow48" class="intersectable" obj-model="obj: #arrow0-obj; mtl: #arrow0-mtl" position="0 -1 0" scale="2 2 2" rotation="0 0 0"></a-entity>

        <!-- look-at="[gps-camera]" -->
      </a-entity>
      <a-camera gps-camera="simulateLatitude: 49.8291455; simulateLongitude: 18.1640326;" rotation-reader> 
        <a-text distance id="distance" class="intersectable" value="23 m" color="blue" scale="0.5 0.5 0.5" position="0 -0.3  -1" rotation="0 0 0" align="center"></a-text>  
      </a-camera>
    </a-scene>
        
    <script>
      const log = console.log;
      const PragueLat = 50.0481443;
      const PragueLng = 14.3022351;
      const BrnoLat = 49.1711527;
      const BrnoLng = 16.5971738;
      const OstravaLat = 49.8384949;
      const OstravaLng = 18.1549161;
      var scene; /* Apply to whole scene */
      var arrow;
      var distance;
      var userLat;
      var userLng;
      var arrowId = 0;
      var listOfArrows = [];
      var wrapper;
      var positionX = 5;
      var positionY = 0;

      window.onload = () => {
        scene = document.querySelector('a-scene'); /* Apply to whole scene */
        wrapper = document.querySelector('[wrapper]');
        arrowEl = document.querySelector('[arrow]');
        distanceEl = document.querySelector('[distance]');

        

        
       /* if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            let gps = document.createAttribute('gps-entity-place');
            let arjs = document.createAttribute('arjs');
            arjs.value = 'sourceType: webcam; sourceWidth: 1280; sourceHeight: 960; trackingMethod: best; debugUIEnabled: false;';
            gps.value = `latitude: ${userLat}; longitude: ${userLng}`;
            scene.setAttributeNode(gps); /* Apply to whole scene */
        /*    scene.setAttributeNode(arjs);    
            /*userLat = position.coords.latitude;
            userLng = position.coords.longitude;*/
        /*    
            log(gps.value);       
            
          }, function (e) {
              log(e.message);
          }, {
              enableHighAccuracy: true
          });
        }*/
      };   
      
      function getPragueAngle() {
        return getAngle(PragueLat, PragueLng);
      }
      
      function getBrnoAngle() {
        return getAngle(BrnoLat, BrnoLng);
      }
      
      function getOstravaAngle() {
        return getAngle(OstravaLat, OstravaLng);
      }
      
      function getAngle(destLat, destLng) {       
        var startLat = userLat;
        var startLng = userLng;
        
        startLat = toRadians(startLat);
        startLng = toRadians(startLng);
        destLat = toRadians(destLat);
        destLng = toRadians(destLng);

        y = Math.sin(destLng - startLng) * Math.cos(destLat);
        x = Math.cos(startLat) * Math.sin(destLat) -
              Math.sin(startLat) * Math.cos(destLat) * Math.cos(destLng - startLng);
        var angle = Math.atan2(y, x);
        angle = toDegrees(angle);

        return Math.round(angle * 10) / 10;
      }
      
      function getPragueDistance() {
        return getDistance(PragueLat, PragueLng);
      }
      
      function getBrnoDistance() {
        return getDistance(BrnoLat, BrnoLng);
      }
      
      function getOstravaDistance() {
        return getDistance(OstravaLat, OstravaLng);
      }
      
      function getDistance(destLat, destLng) {         
        var startLat = userLat;
        var startLng = userLng;
        var R = 6371; // km
        var dLat = toRadians(destLat-startLat);
        var dLon = toRadians(destLng-startLng);
        var lat1 = toRadians(startLat);
        var lat2 = toRadians(destLat);

        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var distance = R * c;

        return Math.round(distance * 10) / 10;
      }
      
      function toRadians(degrees) {
        return degrees * Math.PI / 180;
      };

      // Converts from radians to degrees.
      function toDegrees(radians) {
        return radians * 180 / Math.PI;
      }
      
      function createWay(angle, distance){
        for (i = 1; i <= distance; i++) {
          
          var entityEl = createArrow(angle, i * -7.5 * Math.cos(toRadians(angle)), i * 7.5 * Math.sin(toRadians(angle)));
          listOfArrows.push(entityEl);
          wrapper.appendChild(entityEl);
        }
      }
      
      function createArrow(angle, positionX, positionY){
        arrowId = arrowId + 1;
        var entityEl = document.createElement('a-entity');
        entityEl.setAttribute('id', "arrow" + arrowId);
        entityEl.setAttribute('class', "intersectable");
        if(arrowId % 2 == 0)
        {
          entityEl.setAttribute('obj-model', "obj: #arrow0-obj; mtl: #arrow0-mtl");
        }
        else
        {
          entityEl.setAttribute('obj-model', "obj: #arrow1-obj; mtl: #arrow1-mtl");
        }
        entityEl.setAttribute('rotation', {x: 0, y: -angle, z: 0});
        entityEl.setAttribute('scale', {x: 5, y: 5, z: 5});
        entityEl.setAttribute('position', {x: positionY, y: 0, z: positionX});
        log(angle);
        log(positionX);
        log(positionY);
        
        return entityEl;
      }
      /*
      function createArrow(){
        arrowId = arrowId + 1;
        
        var entityEl = document.createElement('a-entity');
        
        entityEl.setAttribute('id', "arrow" + arrowId);
        entityEl.setAttribute('class', "intersectable");
       
        if(arrowId % 2 == 0)
        {
          entityEl.setAttribute('obj-model', "obj: #arrow0-obj; mtl: #arrow0-mtl");
        }
        else
        {
          entityEl.setAttribute('obj-model', "obj: #arrow1-obj; mtl: #arrow1-mtl");
        }
        
        if(arrowId <=10)
        {
          positionX = positionX - 7.5;
          entityEl.setAttribute('rotation', {x: 0, y: 0, z: 0});
          entityEl.setAttribute('scale', {x: 5, y: 5, z: 5});
          entityEl.setAttribute('position', {x: 0, y: 0, z: positionX});
        }
        
        if(arrowId > 10 &&  arrowId <= 20)
        {
          positionX = positionX - 5;
          positionY = positionY - 5;
          entityEl.setAttribute('rotation', {x: 0, y: 45, z: 0});
          entityEl.setAttribute('scale', {x: 5, y: 5, z: 5});
          entityEl.setAttribute('position', {x: positionY, y: 0, z: positionX});
        }
        
        if(arrowId > 20 &&  arrowId <= 30)
        {
          positionX = positionX - 7.5;
          positionY = positionY;
          entityEl.setAttribute('rotation', {x: 0, y: 0, z: 0});
          entityEl.setAttribute('scale', {x: 5, y: 5, z: 5});
          entityEl.setAttribute('position', {x: positionY, y: 0, z: positionX});
        }
        
        return entityEl;
      }
      */
      function pragueOfficeTurn() {
          createWay(0, 10);
          createWay(45, 5);
          createWay(90, 10);
          createWay(135, 5);
          createWay(180, 10);
          createWay(225, 5);
          createWay(270, 10);
          createWay(315, 5);
         /* createWay(90, 8);
          createWay(135, 6);
          createWay(180, 4);
          createWay(225, 2);*/
        

         /* for (i = 0; i < 30; i++) {
            var entityEl = createArrow();
            listOfArrows.push(entityEl);
            wrapper.appendChild(entityEl);

          }               
          */
          var angle = - getPragueAngle();
          var distance = getPragueDistance();
          log(angle);
          log(distance);
          distanceEl.setAttribute('value', distance + " km");
          arrowEl.setAttribute('rotation', '0 ' + angle + ' 0');
      }
      
      function brnoOfficeTurn() {
          arrowId = 0;
          listOfArrows.forEach(function (item, index) {
            console.log(item, index);
            wrapper.removeChild(item);
          });
          listOfArrows = [];
          positionX = 5;
          positionY = 0;
        
          var angle = getBrnoAngle();
          var distance = getBrnoDistance();
          log(angle);
          log(distance);
          distanceEl.setAttribute('value', distance + " km");
          arrowEl.setAttribute('rotation', '0 ' + -angle + ' 0');
      }
      
      function ostravaOfficeTurn() {
          var angle = getOstravaAngle();
          var distance = getOstravaDistance();
          log(angle);
          log(distance);
          distanceEl.setAttribute('value', distance + " km");
          arrowEl.setAttribute('rotation', '0 ' + -angle + ' 0');
      }
    </script>    
  </body>
</html>
