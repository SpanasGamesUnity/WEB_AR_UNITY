<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Location-based AR.js</title>
    <!-- include aframe -->
    <script src="https://aframe.io/releases/1.0.4/aframe.js"></script>
    <!-- include ar.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
  </head>

  <body style="margin: 0; overflow: hidden;">
    <div style='position: fixed; top: 10px; width:100%; text-align: center; z-index: 1;'>
      <button onclick="pragueOfficeTurn()">CGI PRAGUE</button>
      <button onclick="brnoOfficeTurn()">CGI BRNO</button>
      <button onclick="ostravaOfficeTurn()">CGI OVA</button>
    </div>	
  
    <a-scene vr-mode-ui="enabled: false">
      <a-assets>
        <a-asset-item id="arrow-obj" src="arrow-obj/nnf-arrow.obj"></a-asset-item>
        <a-asset-item id="arrow-mtl" src="arrow-obj/nnf-arrow.mtl"></a-asset-item>
      </a-assets>
      <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: .intersectable; useWorldCoordinates: true;"></a-entity>
      <a-entity id="wrapper" position="0 -8 0" emitevents="true">
        <a-entity arrow id="arrow" class="intersectable" obj-model="obj: #arrow-obj; mtl: #arrow-mtl" position="0 0 -10" scale="5 5 5" rotation="0 0 0"></a-entity>
        <a-text distance id="distance" class="intersectable" value="0 m" color="blue" scale="75 75 75" position="0 -75 -85" rotation="0 0 0" align="center"></a-text>
        <!-- look-at="[gps-camera]" -->
      </a-entity>
      <a-camera gps-camera rotation-reader> </a-camera>
    </a-scene>
        
    <script>
      const log = console.log;
      const PragueLat = 50.0481443;
      const PragueLon = 14.3022351;
      const BrnoLat = 49.1711527;
      const BrnoLon = 16.5971738;
      const OstravaLat = 49.8384949;
      const OstravaLon = 18.1549161;
      var scene; /* Apply to whole scene */
      var arrow;
      var distance;
      var userLat;
      var userLon;

      window.onload = () => {
        scene = document.querySelector('a-scene'); /* Apply to whole scene */
        arrowEl = document.querySelector('[arrow]');
        distanceEl = document.querySelector('[distance]');

        
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            let gps = document.createAttribute('gps-entity-place');
            let arjs = document.createAttribute('arjs');
            arjs.value = 'sourceType: webcam; sourceWidth: 1280; sourceHeight: 960; trackingMethod: best; debugUIEnabled: false;';
            gps.value = `latitude: ${position.coords.latitude}; longitude: ${position.coords.longitude}`;
            scene.setAttributeNode(gps); /* Apply to whole scene */
            scene.setAttributeNode(arjs);    
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            
            log(gps.value);       
            
          }, function (e) {
              log(e.message);
          }, {
              enableHighAccuracy: true
          });
        }
      };
      
      function getPragueAngle() {
        return getAngle(PragueLat, PragueLon);
      }
      
      function getBrnoAngle() {
        return getAngle(BrnoLat, BrnoLon);
      }
      
      function getOstravaAngle() {
        return getAngle(OstravaLat, OstravaLon);
      }
      
      function getAngle(lat2, lon2) {       
        var lat1 = userLat;
        var lon1 = userLon;
        var dLon = (lon2 - lon1);
        var y = Math.sin(dLon) * Math.cos(lat2);
        var x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1)
                * Math.cos(lat2) * Math.cos(dLon);
        var angle = Math.atan2(y, x);
        angle = angle * (180/Math.PI);       

        return Math.round(angle * 10) / 10;
      }
      
      function getPragueDistance() {
        return getDistance(PragueLat, PragueLon);
      }
      
      function getBrnoDistance() {
        return getDistance(BrnoLat, BrnoLon);
      }
      
      function getOstravaDistance() {
        return getDistance(OstravaLat, OstravaLon);
      }
      
      function getDistance(lat2, lon2) {         
        var lat1 = userLat;
        var lon1 = userLon;
        var R = 6371; // km
        var dLat = toRad(lat2-lat1);
        var dLon = toRad(lon2-lon1);
        var lat1 = toRad(lat1);
        var lat2 = toRad(lat2);

        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var distance = R * c;

        return Math.round(distance * 10) / 10;
      }
      
      // Converts numeric degrees to radians
      function toRad(value) 
      {
          return value * Math.PI / 180;
      }
      
      function pragueOfficeTurn() {
          var angle = getPragueAngle();
          var distance = getPragueDistance();
          log(angle);
          log(distance);
          distanceEl.setAttribute('value', distance + " km");
          arrowEl.setAttribute('rotation', '0 ' + angle + ' 0');
      }
      
      function brnoOfficeTurn() {
          var angle = getBrnoAngle();
          var distance = getBrnoDistance();
          log(angle);
          log(distance);
          distanceEl.setAttribute('value', distance + " km");
          arrowEl.setAttribute('rotation', '0 ' + angle + ' 0');
      }
      
      function ostravaOfficeTurn() {
          var angle = getOstravaAngle();
          var distance = getOstravaDistance();
          log(angle);
          log(distance);
          distanceEl.setAttribute('value', distance + " km");
          arrowEl.setAttribute('rotation', '0 ' + angle + ' 0');
      }
    </script>    
  </body>
</html>
